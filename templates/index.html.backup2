<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>FM Monitor - Graffiti Radio</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700&display=swap" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link href="/static/assets/css/material-dashboard.css?v=3.1.0" rel="stylesheet" />

  <style>
    body {
        font-family: 'Inter', sans-serif;
        background: #fafbfc;
    }

    .sidenav {
        background: #2c3e50 !important;
    }

    .card {
        box-shadow: 0 1px 2px rgba(0,0,0,0.06) !important;
        border: 1px solid #e1e4e8;
        background: white;
    }

    .card-header {
        background: white;
        border-bottom: 1px solid #e1e4e8;
        padding: 16px 20px;
    }

    .card-header h6 {
        color: #24292e;
        font-weight: 600;
        font-size: 14px;
        margin: 0;
    }

    .stat-card-simple {
        padding: 20px;
    }

    .stat-label {
        font-size: 12px;
        color: #6a737d;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 24px;
        color: #24292e;
        font-weight: 600;
    }

    .config-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: none;
    }

    .config-info-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }

    .config-info-item:last-child {
        margin-bottom: 0;
    }

    .config-info-label {
        font-size: 11px;
        opacity: 0.9;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .config-info-value {
        font-size: 16px;
        font-weight: 700;
        font-family: 'Courier New', monospace;
    }

    .vu-meter-container {
        background: white;
        border-radius: 6px;
        padding: 20px;
        border: 1px solid #e1e4e8;
    }

    .vu-meter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .vu-meter-title {
        font-size: 11px;
        font-weight: 600;
        color: #6a737d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .vu-meter-value {
        font-family: 'Courier New', monospace;
        font-size: 18px;
        font-weight: 700;
        color: #24292e;
    }

    .vu-meter-bars-container {
        display: flex;
        gap: 1px;
        height: 70px;
        align-items: flex-end;
        background: #f6f8fa;
        border-radius: 4px;
        padding: 6px;
    }

    .vu-bar {
        flex: 1;
        height: 100%;
        display: flex;
        align-items: flex-end;
        background: transparent;
    }

    .vu-bar-fill {
        width: 100%;
        height: 0%;
        transition: height 0.05s linear;
        border-radius: 1px 1px 0 0;
    }

    .vu-meter-scale {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 9px;
        color: #959da5;
        font-weight: 500;
    }

    .play-button {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 2px solid #d1d5da;
        background: white;
        color: #24292e;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .play-button:hover {
        border-color: #0366d6;
        color: #0366d6;
    }

    .play-button.playing {
        border-color: #0366d6;
        background: #0366d6;
        color: white;
    }

    .material-icons-round {
        font-size: 28px;
    }

    .volume-control {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .volume-slider {
        flex: 1;
        height: 3px;
        border-radius: 2px;
        background: #e1e4e8;
        outline: none;
        -webkit-appearance: none;
    }

    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #0366d6;
        cursor: pointer;
    }

    .rds-ps-display {
        font-family: 'Courier New', monospace;
        font-size: 28px;
        font-weight: 700;
        color: #24292e;
        background: #f6f8fa;
        padding: 18px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #e1e4e8;
        letter-spacing: 2px;
        min-height: 65px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .rds-rt-display {
        font-size: 13px;
        color: #586069;
        background: #f6f8fa;
        padding: 14px;
        border-radius: 6px;
        min-height: 55px;
        border-left: 3px solid #0366d6;
        line-height: 1.5;
    }

    .alert {
        background: #f1f8ff;
        border: 1px solid #c8e1ff;
        color: #0366d6;
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 12px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        border: 1px solid;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #0366d6;
        color: white;
        border-color: #0366d6;
    }

    .btn-primary:hover:not(:disabled) {
        background: #0256c7;
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-200">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3" style="background: #2c3e50;">
    <div class="sidenav-header">
      <a class="navbar-brand m-0" href="/">
        <i class="material-icons-round text-white" style="font-size: 24px;">radio</i>
        <span class="ms-2 font-weight-bold text-white">FM Monitor</span>
      </a>
    </div>
    <hr class="horizontal light mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-white" href="/" style="background: rgba(255,255,255,0.1);">
            <i class="material-icons-round" style="font-size: 20px;">dashboard</i>
            <span class="ms-2">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/config">
            <i class="material-icons-round" style="font-size: 20px;">settings</i>
            <span class="ms-2">Configuration</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/stats">
            <i class="material-icons-round" style="font-size: 20px;">assessment</i>
            <span class="ms-2">Statistiques</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <a class="nav-link text-white" href="/logout">
            <i class="material-icons-round" style="font-size: 20px;">logout</i>
            <span class="ms-2">Déconnexion</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl">
      <div class="container-fluid py-1 px-3">
        <h6 class="font-weight-bolder mb-0" style="color: #24292e;">Dashboard</h6>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <!-- Configuration en cours -->
      <div class="card config-info">
        <div class="row">
          <div class="col-md-3">
            <div class="config-info-item">
              <i class="material-icons-round" style="font-size: 20px;">radio</i>
              <div>
                <div class="config-info-label">Station</div>
                <div class="config-info-value" id="station-name-display">Chargement...</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="config-info-item">
              <i class="material-icons-round" style="font-size: 20px;">signal_cellular_alt</i>
              <div>
                <div class="config-info-label">Fréquence</div>
                <div class="config-info-value" id="frequency-display">Chargement...</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="config-info-item">
              <i class="material-icons-round" style="font-size: 20px;">schedule</i>
              <div>
                <div class="config-info-label">Démarrage monitoring</div>
                <div class="config-info-value" id="start-time-display">Chargement...</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="config-info-item">
              <i class="material-icons-round" style="font-size: 20px;">email</i>
              <div>
                <div class="config-info-label">Email alarme</div>
                <div class="config-info-value" id="email-display" style="font-size: 13px;">Chargement...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="row">
        <div class="col-xl-3 col-sm-6 mb-4">
          <div class="card">
            <div class="stat-card-simple">
              <div class="stat-label">Peak Level</div>
              <div class="stat-value" id="level-display">-100.00 dBFS</div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-sm-6 mb-4">
          <div class="card">
            <div class="stat-card-simple">
              <div class="stat-label">Uptime</div>
              <div class="stat-value" id="uptime-display">0h 0m</div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-sm-6 mb-4">
          <div class="card">
            <div class="stat-card-simple">
              <div class="stat-label">Alertes</div>
              <div class="stat-value" id="alerts-display">0</div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-sm-6 mb-4">
          <div class="card">
            <div class="stat-card-simple">
              <div class="stat-label">Signal</div>
              <div class="stat-value" id="status-display">Signal OK</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Player & RDS -->
      <div class="row">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h6>Lecteur Audio & VU-Mètre</h6>
            </div>
            <div class="card-body">
              <audio id="audio-player" preload="auto"></audio>

              <div class="d-flex align-items-center mb-4">
                <button class="play-button me-3" id="play-btn" onclick="togglePlay()">
                  <i class="material-icons-round">play_arrow</i>
                </button>

                <div class="volume-control flex-grow-1">
                  <i class="material-icons-round" style="color: #6a737d; font-size: 20px;">volume_up</i>
                  <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="80">
                  <span id="volume-value" style="font-size: 13px; color: #6a737d; font-weight: 500;">80%</span>
                </div>
              </div>

              <div class="vu-meter-container">
                <div class="vu-meter-header">
                  <span class="vu-meter-title">Peak Level (dBFS)</span>
                  <span class="vu-meter-value" id="vu-meter-value-main">-100.00</span>
                </div>

                <div class="vu-meter-bars-container" id="vu-meter-bars-main"></div>

                <div class="vu-meter-scale">
                  <span>-100</span>
                  <span>-80</span>
                  <span>-60</span>
                  <span>-40</span>
                  <span>-20</span>
                  <span>0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h6>Informations RDS</h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="stat-label mb-2">Program Service (PS)</div>
                <div class="rds-ps-display" id="rds-ps-display">-</div>
                <button class="btn btn-sm btn-primary mt-2" onclick="readRDSPS()" id="btn-read-ps">
                  <i class="material-icons-round" style="font-size: 16px; vertical-align: middle;">refresh</i>
                  Lire PS (10s)
                </button>
              </div>

              <div class="mb-3">
                <div class="stat-label mb-2">RadioText (RT)</div>
                <div class="rds-rt-display" id="rds-rt-display">-</div>
                <button class="btn btn-sm btn-primary mt-2" onclick="readRDSRT()" id="btn-read-rt">
                  <i class="material-icons-round" style="font-size: 16px; vertical-align: middle;">refresh</i>
                  Lire RT (10s)
                </button>
              </div>

              <div class="alert">
                <i class="material-icons-round me-2" style="font-size: 16px; vertical-align: middle;">info</i>
                Cliquez sur les boutons pour lire les données RDS à la demande
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/static/assets/js/core/popper.min.js"></script>
  <script src="/static/assets/js/core/bootstrap.min.js"></script>
  <script src="/static/assets/js/material-dashboard.min.js?v=3.1.0"></script>

  <script>
    const audioPlayer = document.getElementById('audio-player');
    const playBtn = document.getElementById('play-btn');
    const volumeSlider = document.getElementById('volume-slider');
    let isPlaying = false;

    function togglePlay() {
        if (isPlaying) {
            audioPlayer.pause();
            playBtn.innerHTML = '<i class="material-icons-round">play_arrow</i>';
            playBtn.classList.remove('playing');
            isPlaying = false;
        } else {
            audioPlayer.src = '/stream.mp3?nocache=' + Date.now();
            audioPlayer.load();
            audioPlayer.play();
            playBtn.innerHTML = '<i class="material-icons-round">pause</i>';
            playBtn.classList.add('playing');
            isPlaying = true;
        }
    }

    audioPlayer.addEventListener('waiting', () => {
        console.log('Buffering...');
    });

    audioPlayer.addEventListener('canplay', () => {
        console.log('Can play');
    });

    audioPlayer.addEventListener('error', (e) => {
        console.error('Audio error:', e);
        if (isPlaying) {
            setTimeout(() => {
                audioPlayer.src = '/stream.mp3?nocache=' + Date.now();
                audioPlayer.load();
                audioPlayer.play();
            }, 1000);
        }
    });

    volumeSlider.addEventListener('input', (e) => {
        audioPlayer.volume = e.target.value / 100;
        document.getElementById('volume-value').textContent = e.target.value + '%';
    });
    audioPlayer.volume = 0.8;

    // VU-Meter
    const vuMeterBarsMain = document.getElementById('vu-meter-bars-main');
    const vuBarsMain = [];
    for (let i = 0; i < 200; i++) {
        const bar = document.createElement('div');
        bar.className = 'vu-bar';
        const fill = document.createElement('div');
        fill.className = 'vu-bar-fill';

        const percent = (i / 200) * 100;
        if (percent < 60) {
            fill.style.backgroundColor = '#28a745';
        } else if (percent < 75) {
            fill.style.backgroundColor = '#ffc107';
        } else {
            fill.style.backgroundColor = '#dc3545';
        }

        bar.appendChild(fill);
        vuMeterBarsMain.appendChild(bar);
        vuBarsMain.push(fill);
    }

    function updateVUMeter(levelValue) {
        const value = Math.max(0, Math.min(100, levelValue));
        const dbValue = value - 100;

        document.getElementById('vu-meter-value-main').textContent = dbValue.toFixed(2);

        const activeBars = Math.round((value / 100) * 200);

        for (let i = 0; i < vuBarsMain.length; i++) {
            if (i < activeBars) {
                vuBarsMain[i].style.height = '100%';
            } else {
                vuBarsMain[i].style.height = '0%';
            }
        }
    }

    async function loadConfig() {
        try {
            const response = await fetch('/api/config/full');
            const config = await response.json();

            const stationName = config.station?.name || 'Graffiti Radio';
            const frequency = config.rtl_sdr?.frequency || config.station?.frequency || '88.6M';

            let emailDisplay = 'Non configuré';
            if (config.email?.recipient_emails) {
                const recip = config.email.recipient_emails;
                if (typeof recip === 'string') {
                    emailDisplay = recip.split(',')[0].trim();
                } else if (Array.isArray(recip) && recip.length > 0) {
                    emailDisplay = recip[0];
                }
            }

            document.getElementById('station-name-display').textContent = stationName;
            document.getElementById('frequency-display').textContent = frequency;
            document.getElementById('email-display').textContent = emailDisplay;
        } catch (error) {
            console.error('Erreur config:', error);
        }
    }

    async function updateStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            const level = stats.current_level || -100;
            const levelPercent = Math.max(0, Math.min(100, level + 100));

            document.getElementById('level-display').textContent = level.toFixed(2) + ' dBFS';
            updateVUMeter(levelPercent);

            const uptimeSeconds = stats.uptime || 0;
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            document.getElementById('uptime-display').textContent = hours + 'h ' + minutes + 'm';

            document.getElementById('alerts-display').textContent = stats.alerts_sent || 0;
            document.getElementById('status-display').textContent = stats.signal_ok ? 'Signal OK' : 'Signal Perdu';

            if (stats.start_time) {
                document.getElementById('start-time-display').textContent = stats.start_time;
            }

        } catch (error) {
            console.error('Erreur:', error);
        }
    }

    async function readRDSPS() {
        const btn = document.getElementById('btn-read-ps');
        const display = document.getElementById('rds-ps-display');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons-round" style="font-size: 16px; vertical-align: middle;">hourglass_empty</i> Lecture en cours...';
            display.textContent = 'Lecture en cours...';
            
            const response = await fetch('/api/rds/read_ps', { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                display.textContent = data.ps || 'Non disponible';
            } else {
                display.textContent = 'Erreur lecture';
            }
        } catch (error) {
            console.error('Erreur RDS PS:', error);
            display.textContent = 'Erreur';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="material-icons-round" style="font-size: 16px; vertical-align: middle;">refresh</i> Lire PS (10s)';
        }
    }

    async function readRDSRT() {
        const btn = document.getElementById('btn-read-rt');
        const display = document.getElementById('rds-rt-display');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons-round" style="font-size: 16px; vertical-align: middle;">hourglass_empty</i> Lecture en cours...';
            display.textContent = 'Lecture en cours...';
            
            const response = await fetch('/api/rds/read_rt', { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                display.textContent = data.rt || 'Non disponible';
            } else {
                display.textContent = 'Erreur lecture';
            }
        } catch (error) {
            console.error('Erreur RDS RT:', error);
            display.textContent = 'Erreur';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="material-icons-round" style="font-size: 16px; vertical-align: middle;">refresh</i> Lire RT (10s)';
        }
    }

    // Chargement initial
    loadConfig();
    updateStats();

    // Mise à jour stats uniquement
    setInterval(updateStats, 50);
  </script>
</body>
</html>
