#!/usr/bin/env python3
"""
Application web Flask pour la surveillance FM
"""

from flask import Flask, render_template, Response, jsonify, request
import json
import logging
import sys
import time
from monitor import FMMonitor

# Configuration du logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/fm-monitor.log'),
        logging.StreamHandler(sys.stdout)
    ]
)

logger = logging.getLogger(__name__)

app = Flask(__name__)

# Initialiser le moniteur FM
monitor = None


def init_monitor():
    """Initialise et démarre le moniteur FM"""
    global monitor
    try:
        monitor = FMMonitor('config.json')
        monitor.start()
        logger.info("Moniteur FM initialisé et démarré")
    except Exception as e:
        logger.error(f"Erreur lors de l'initialisation du moniteur: {e}")
        raise


@app.route('/')
def index():
    """Page d'accueil"""
    return render_template('index.html')


@app.route('/config')
def config_page():
    """Page de configuration"""
    return render_template('config.html')


@app.route('/api/stats')
def get_stats():
    """Retourne les statistiques du moniteur"""
    if monitor:
        return jsonify(monitor.get_stats())
    return jsonify({'error': 'Moniteur non initialisé'}), 500


@app.route('/api/config')
def get_config():
    """Retourne la configuration publique"""
    try:
        with open('config.json', 'r') as f:
            config = json.load(f)
        
        # Trouver le preset actif
        current_preset = None
        current_freq = config['rtl_sdr']['frequency']
        presets = config.get('presets', [])
        
        for preset in presets:
            if preset['frequency'] == current_freq:
                current_preset = preset['name']
                break
        
        # Ne retourner que les infos publiques (pas les mots de passe)
        public_config = {
            'station': config['station'],
            'frequency': config['rtl_sdr']['frequency'],
            'current_preset': current_preset,
            'audio': {
                'output_rate': config['audio']['output_rate'],
                'channels': config['audio']['channels']
            }
        }
        return jsonify(public_config)
    except Exception as e:
        logger.error(f"Erreur lors de la lecture de la config: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/config/full')
def get_config_full():
    """Retourne la configuration complète (pour la page de config)"""
    try:
        with open('config.json', 'r') as f:
            config = json.load(f)
        return jsonify(config)
    except Exception as e:
        logger.error(f"Erreur lors de la lecture de la config: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/config/save', methods=['POST'])
def save_config():
    """Sauvegarde la configuration"""
    try:
        new_config = request.get_json()
        
        # Charger la config actuelle
        with open('config.json', 'r') as f:
            config = json.load(f)
        
        # Mettre à jour les sections
        if 'rtl_sdr' in new_config:
            if 'frequency' in new_config['rtl_sdr']:
                config['rtl_sdr']['frequency'] = new_config['rtl_sdr']['frequency']
            if 'gain' in new_config['rtl_sdr']:
                config['rtl_sdr']['gain'] = new_config['rtl_sdr']['gain']
        
        if 'station' in new_config:
            if 'name' in new_config['station']:
                config['station']['name'] = new_config['station']['name']
                config['station']['frequency_display'] = new_config['rtl_sdr'].get('frequency', config['rtl_sdr']['frequency'])
        
        if 'email' in new_config:
            if 'sender_email' in new_config['email']:
                config['email']['sender_email'] = new_config['email']['sender_email']
            if 'sender_password' in new_config['email']:
                config['email']['sender_password'] = new_config['email']['sender_password']
            if 'recipient_emails' in new_config['email']:
                config['email']['recipient_emails'] = new_config['email']['recipient_emails']
        
        if 'audio' in new_config:
            if 'silence_threshold' in new_config['audio']:
                config['audio']['silence_threshold'] = new_config['audio']['silence_threshold']
            if 'silence_duration' in new_config['audio']:
                config['audio']['silence_duration'] = new_config['audio']['silence_duration']
        
        # Sauvegarder la config
        with open('config.json', 'w') as f:
            json.dump(config, f, indent=2)
        
        logger.info("Configuration sauvegardée")
        return jsonify({'status': 'success', 'message': 'Configuration enregistrée'})
        
    except Exception as e:
        logger.error(f"Erreur lors de la sauvegarde de la config: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500


@app.route('/api/presets')
def get_presets():
    """Retourne la liste des presets"""
    try:
        with open('config.json', 'r') as f:
            config = json.load(f)
        
        presets = config.get('presets', [])
        return jsonify({'status': 'success', 'presets': presets})
    except Exception as e:
        logger.error(f"Erreur lors de la lecture des presets: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500


@app.route('/api/presets/save', methods=['POST'])
def save_presets():
    """Sauvegarde les presets"""
    try:
        data = request.get_json()
        presets = data.get('presets', [])
        
        # Charger la config
        with open('config.json', 'r') as f:
            config = json.load(f)
        
        # Mettre à jour les presets
        config['presets'] = presets
        
        # Sauvegarder
        with open('config.json', 'w') as f:
            json.dump(config, f, indent=2)
        
        logger.info(f"Presets sauvegardés: {len(presets)} presets")
        return jsonify({'status': 'success', 'message': 'Presets enregistrés'})
        
    except Exception as e:
        logger.error(f"Erreur lors de la sauvegarde des presets: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500


@app.route('/api/presets/load/<preset_id>', methods=['POST'])
def load_preset(preset_id):
    """Charge un preset et redémarre le service"""
    try:
        # Charger la config
        with open('config.json', 'r') as f:
            config = json.load(f)
        
        # Trouver le preset
        presets = config.get('presets', [])
        preset = next((p for p in presets if p['id'] == preset_id), None)
        
        if not preset:
            return jsonify({'status': 'error', 'message': 'Preset non trouvé'}), 404
        
        # Appliquer le preset
        config['rtl_sdr']['frequency'] = preset['frequency']
        config['rtl_sdr']['gain'] = preset.get('gain', 'auto')
        config['station']['name'] = preset['name']
        config['station']['frequency_display'] = preset['frequency']
        
        # Sauvegarder
        with open('config.json', 'w') as f:
            json.dump(config, f, indent=2)
        
        logger.info(f"Preset chargé: {preset['name']} ({preset['frequency']})")
        
        # Redémarrer le moniteur
        global monitor
        if monitor and monitor.running:
            monitor.stop()
        init_monitor()
        
        return jsonify({
            'status': 'success',
            'message': f'Preset "{preset["name"]}" chargé',
            'preset': preset
        })
        
    except Exception as e:
        logger.error(f"Erreur lors du chargement du preset: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500


@app.route('/stream.mp3')
def stream():
    """Stream audio en direct"""
    def generate():
        """Générateur de chunks audio"""
        logger.info("Client connecté au stream audio")
        try:
            consecutive_empty = 0
            max_empty = 50
            
            while True:
                if monitor and monitor.running:
                    chunk = monitor.get_audio_chunk()
                    if chunk:
                        consecutive_empty = 0
                        yield chunk
                    else:
                        consecutive_empty += 1
                        if consecutive_empty > max_empty:
                            logger.warning("Pas de données audio depuis trop longtemps")
                            break
                        time.sleep(0.1)
                else:
                    break
        except GeneratorExit:
            logger.info("Client déconnecté du stream audio")
        except Exception as e:
            logger.error(f"Erreur de streaming: {e}")
    
    return Response(
        generate(),
        mimetype='audio/mpeg',
        headers={
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0',
            'Content-Type': 'audio/mpeg',
            'Transfer-Encoding': 'chunked'
        }
    )


@app.route('/api/control/<action>', methods=['POST'])
def control(action):
    """Contrôle du moniteur (start/stop/restart)"""
    global monitor
    
    try:
        if action == 'start':
            if monitor is None or not monitor.running:
                init_monitor()
                return jsonify({'status': 'success', 'message': 'Monitoring démarré'})
            return jsonify({'status': 'info', 'message': 'Monitoring déjà actif'})
        
        elif action == 'stop':
            if monitor and monitor.running:
                monitor.stop()
                return jsonify({'status': 'success', 'message': 'Monitoring arrêté'})
            return jsonify({'status': 'info', 'message': 'Monitoring déjà arrêté'})
        
        elif action == 'restart':
            if monitor and monitor.running:
                monitor.stop()
            init_monitor()
            return jsonify({'status': 'success', 'message': 'Monitoring redémarré'})
        
        else:
            return jsonify({'status': 'error', 'message': 'Action inconnue'}), 400
            
    except Exception as e:
        logger.error(f"Erreur de contrôle ({action}): {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500


@app.route('/api/test-email', methods=['POST'])
def test_email():
    """Envoie un email de test"""
    try:
        if monitor and monitor.email_alert:
            success = monitor.email_alert.send_alert(
                "Test du système d'alertes",
                "Ceci est un email de test pour vérifier la configuration."
            )
            if success:
                return jsonify({'status': 'success', 'message': 'Email de test envoyé'})
            else:
                return jsonify({'status': 'error', 'message': 'Échec de l\'envoi'}), 500
        return jsonify({'status': 'error', 'message': 'Moniteur non initialisé'}), 500
    except Exception as e:
        logger.error(f"Erreur lors du test email: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500


def main():
    """Point d'entrée principal"""
    # Charger la configuration
    with open('config.json', 'r') as f:
        config = json.load(f)
    
    # Démarrer le moniteur
    init_monitor()
    
    # Démarrer l'application web
    host = config['web']['host']
    port = config['web']['port']
    
    logger.info(f"Démarrage du serveur web sur {host}:{port}")
    
    try:
        app.run(
            host=host,
            port=port,
            debug=False,
            threaded=True
        )
    except KeyboardInterrupt:
        logger.info("Arrêt demandé par l'utilisateur")
    finally:
        if monitor:
            monitor.stop()


if __name__ == '__main__':
    main()
